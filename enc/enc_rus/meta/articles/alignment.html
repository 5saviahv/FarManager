<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>Как настроить Alignment</title>
<meta http-equiv="Content-Type" Content="text/html; charset=utf-8">
<link rel="stylesheet" type="text/css" href="../../styles/styles.css">
<meta name="Author" content="Igor Pavlov">
<meta name="description" content="Как настроить Alignment">
<script language="javascript" src='../links.js' type="text/javascript"></script>
</head>

<body>

<a name="top"></a>
<h1>Как настроить Alignment</h1>
<div class=navbar>
<a href="../index.html">главная</a> |
<a href="index.html">статьи</a>
</div>

<div align=right><code>
Игорь Павлов
</code></div>
<hr color="#003399">

<p class=plain>
Известно, что все структуры, определенные для обмена между FAR'ом и
плагинами, должны быть откомпилированы при alignment = 1 (или 2).
Чтобы не возникало проблем у авторов плагинов, файл
&quot;<dfn>plugin.hpp</dfn>&quot; содержит следующие конструкции:

<pre class=code>#if defined(__BORLANDC__) &amp;&amp; (__BORLANDC &lt;= 0x520)
  #pragma option -a1
#elif defined(__GNUC__) || (defined(__WATCOMC__) &amp;&amp; (__WATCOMC__ &lt; 1100))
  #pragma pack(1)
#else
  #pragma pack(push,1)
  #if _MSC_VER
    #define _export
  #endif
#endif

...


#if defined(__BORLANDC__) &amp;&amp; (__BORLANDC &lt;= 0x520)
  #pragma option -a.
#elif defined(__GNUC__) || (defined(__WATCOMC__) &amp;&amp; (__WATCOMC__ &lt; 1100))
  #pragma pack()
#else
  #pragma pack(pop)
#endif
</pre>

<p class=plain>Они устанавливают значение alignment = 1
для всех структур, определенных в &quot;<dfn>plugin.hpp</dfn>&quot;. Но структура
        <a href="../structures/pluginpanelitem.html">PluginPanelItem</a>
включает в себя структуру <a href="../winapi/win32_find_data.html">WIN32_FIND_DATA</a>
из Win32 SDK:

<pre class=code>PluginPanelItem
{
  WIN32_FIND_DATA FindData;
...
</pre>

<p class=plain>
Т.е. при работе с <dfn>PluginPanelItem</dfn> крайне важно, чтобы структура
<dfn>WIN32_FIND_DATA</dfn> была откомпилирована со значением alignment = 1 (или 2).
Но <dfn>WIN32_FIND_DATA</dfn> определена в одном из <b>h</b> файлов Win32 SDK.
Это означает, что значение alignment для нее не зависит от &quot;<dfn>plugin.hpp</dfn>&quot;.
Здесь и может возникнуть ошибка.

<p class=plain>
<a href="mailto:Michael Yutsis <michael.y@sapiens.com>">Михаил Юцис</a> в файле
&quot;<b>VCReadme.txt</b>&quot;, который идет в комплекте
с FAR Plugin API, советует компилировать весь проект при alignment = 2 (или 1).
Тогда <b>sizeof(WIN32_FIND_DATA) = 318</b> (OK для FAR'а).
Но для нового проекта по умолчанию стоит значение alignment = 8 и
<b>sizeof(WIN32_FIND_DATA) = 320</b> (а FAR считает, что 318).
Т.е. нужно изменить значение в Project / Settings / C/C++ / Code Generation
/ Struct member alignment на 1 или 2. Но тогда возникает другая проблема.
В Win32 есть файлы, которые должны быть скомпилированы при alignment = 8.
Например, <b>&lt;wincon.h&gt;</b>, который содержит структуры
из Console API. Михаил Юцис для решения этой проблемы предлагает
следующий трюк:

<pre class=code>#define _WINCON_      // предотвратить включение wincon.h
#include &lt;windows.h&gt;
#undef _WINCON_
#include &quot;plugin.hpp&quot; // этот файл хочет 1-byte alignment
#pragma pack(8)
#include &lt;wincon.h&gt;   // этот файл хочет 8-bytes alignment
</pre>

<p class=plain>
Но существует другое решение, которое предложил Евгений Рошал.
Достаточно лишь определить  в файле &quot;<b>plugin.hpp</b>&quot; структуру
<b>FarFindData</b>

<pre class=code>struct FarFindData
{
  DWORD dwFileAttributes;
  FILETIME ftCreationTime;
  FILETIME ftLastAccessTime;
  FILETIME ftLastWriteTime;
  DWORD nFileSizeHigh;
  DWORD nFileSizeLow;
  DWORD dwReserved0;
  DWORD dwReserved1;
  char cFileName[ MAX_PATH ];
  char cAlternateFileName[ 14 ];
};
</pre>

<p class=plain>
и заменить <b>WIN32_FIND_DATA</b> на <b>FarFindData</b>:

<pre class=code>PluginPanelItem
{
  FarFindData FindData;
...
</pre>

<p class=plain>
А компилировать проект следует при alignment = 8.

<p class=plain>
Какие преимущества от такого метода:
<ul>
<li> Меньше лишних действий при создании нового проекта.
<li> Повышается скорость работы программы.
</ul>

<p class=plain>
Хотя Евгений и предложил это решение, он пока не хочет распространять
его на официальную версию, т.к. для некоторых плагинов потребуется
вносить небольшие изменения.
</p>

<div align=right><code>
<br>&nbsp;<br>
24.12.1999
</code></div>

<div class=seecont><a href="#top">наверх</a></div>

</body>
</html>