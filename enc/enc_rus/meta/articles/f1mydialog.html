<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>Подсказка в нестандартных диалогах.</title>
<meta http-equiv="Content-Type" Content="text/html; charset=utf-8">
<link rel="stylesheet" type="text/css" href="../../styles/styles.css">
<link REV="made" href="mailto:vskirdin@mail.ru, ruiv@uic.nnov.ru">
<meta name="Author" content="Valentin Skirdin, Igor Ruskih">
<meta name="description" content="Подсказка в нестандартных диалогах.. Help in nonstandard dialogues.">
<script language="JavaScript" src='../links.js' type="text/javascript"></script>
</head>
<!-- History of modification:
 Date: Nov 10 1999
   Author: Valentin Skirdin
   E-mail: vskirdin@mail.ru
-->
<body>

<a name="top"></a>
<h1>Подсказка в &quot;нестандартных&quot; диалогах.</h1>
<div class=navbar>
<a href="../index.html">главная</a> |
<a href="index.html">статьи</a>
</div>

<div align=right><code>
Валентин Скирдин <a href="mailto:Valentin%20Skirdin%20<vskirdin@mail.ru>?subject=Articles">
<img src="../../images/email.gif" border="0" alt="[vskirdin@mail.ru]" width="16" height="16" align="middle">vskirdin@mail.ru
</a><br>
Игорь Русских <a href="mailto:Igor%20Ruskih%20<ruiv@uic.nnov.ru>?subject=Articles">
<img src="../../images/email.gif" border="0" alt="[ruiv@uic.nnov.ru]" width="16" height="16" align="middle">ruiv@uic.nnov.ru
</a>
</code></div>
<hr color="#003399">


<p class=plain>
Что такое <em>&laquo;нестандартные&raquo;</em>
диалоги можно увидеть на примере плагинов
&quot;<a target="_blank" href="http://plugring.farmanager.com/cgi-bin/downld.cgi?Draw=List&Select=PlugIn&SelectPlugIn=26">Active Symbol Table</a>&quot;
или &quot;<a target="_blank" href="http://plugring.farmanager.com/cgi-bin/downld.cgi?Draw=List&Select=PlugIn&SelectPlugIn=15">Calculator</a>&quot;.
Их нестандартность заключается в том, что эти
плагины не используют Dialog API от FAR...</p>

<h3>FAR Manager до 1.65 (включительно)</h3>

<p class=plain>...А почему? А
потому, что стандартному Dialog API не хватает
&quot;интерактивности&quot;, а именно <b>нормального
обработчика диалогов</b>. Тот &quot;куцый&quot;
интерфейс, который предоставляет Dialog API, не
позволяет сделать нормальный интерактивный
диалог. Выхода здесь два: </p>

<div class=descr>
  <p>Первое - просить Евгения Рошала переписать Dialog
  API с поддержкой пользовательской
  функции-обработчика диалога.<br>
  Второе - &quot;извращаться&quot;, путем создания
  своего оконного интерфейса... </p>
</div>

<p class=plain>
Но не о том здесь речь. Все бы
хорошо, да вот только нету в Plugins API еще одной
детали - API для вызова Help. Но выход есть, и весьма
оригинальный: <b>диалог About</b> на основе
стандартного Dialog API (<i>уж этот умеет правильно
реагировать на клавишу F1</i>), например такого: </p>

<p align="center"><img src="../../images/f1mydialog.gif" width="208" height="156" alt="About"></p>

<p class=plain>
В пример, приведенном ниже, показано как
вызвать подсказку из плагина, работающего в
редакторе.</p>

<pre class=code>HANDLE WINAPI _export OpenPlugin(int OpenFrom,int Item)
{
  <a href="../winapi/input_record.html">INPUT_RECORD</a> rec;
  BOOL done=FALSE;
  ...
  while (!done)
  {
    <b>Info.<a href="../service_functions/editorcontrol.html">EditorControl</a>(ECTL_READINPUT,&amp;rec);</b>
    ...
    if (rec.Event.KeyEvent.wVirtualKeyCode == VK_F1 &amp;&amp;
        rec.Event.KeyEvent.bKeyDown)
    {
      // <em>засылаем F1 в очередь...</em>
      <b><a href="../winapi/writeconsoleinput.html">WriteConsoleInput</a></b>(<a href="win32/getstdhandle.html">GetStdHandle</a>(STD_INPUT_HANDLE),
           &amp;rec,1,&amp;lpNumberOfEventsWritten);
      // ... и выводим диалог
      Info.<a href="../dialogapi/dialog.html">Dialog</a>(Info.ModuleNumber,-1,-1,26,13,
           <b>&quot;Navigate&quot;</b>,DialogItems,numItems);

    }
    ...
  }
  ...
}</pre>

<p class=plain>
Все проще пареной репы - во входную
очередь подло подсовывается сообщение как бы о
нажатии клавиши F1, и затем с чистой совестью
создается стандартный диалог. Он естественно
пытается читать входную очередь и находит там
заблаговременно подсунутое нами событие.
Остальное дело техники и Far-а.</p>

<p class=plain>
Единственный недостаток этого
метода в том, что то самое маленькое диалоговое
окошко так и остается висеть, пока пользователь
его не закроет.</p>

<p class=plain>
В большинстве случаев это неважно -
но иногда в плагинах, где надо довольно часто
ползать в хелп за подсказкой (навроде того же
калькулятора) это достает. Вообще, здесь
присутствует довольно тонкий психологический
момент - пользователю быстро это надоедает.</p>

<p class=plain>
К слову сказать, автору плагина <a target="_blank" href="http://plugring.farmanager.com/cgi-bin/downld.cgi?Draw=List&Select=PlugIn&SelectPlugIn=120">HexEditor</a>
Алексею Пахотину удалось довольно просто
разрешить этот конфликт - я (Игорь) в порыве
хакерства как-то не обратил на этот момент
внимания. Человеку будет не влом закрывать этот
диалог, если он сам его открыл, и сам вызвал из
него хелп. Таким образом в его HexEditor-е просто-напросто
выводится довольно большой диалог с копирайтами
(а как же - мы все гордые:)), в котором пользователю
предлагается при желании нажать еще и F1. А потом?
А сам нажал - сам и убирай. В этом случае вам не
надо знать архитектуру консолей виндов, а тем
более каких-то там странных функций по записи
сообщений, которых никогда и не было.</p>

<p class=plain>
Будьте проще.<br>&nbsp;<br>
</p>

<h3>FAR Manager 1.70 и выше</h3>
<p class=plain>Вот здесь подобных "извращений" делать не нужно.
Все уже сделано - сервисная функция <a href="../service_functions/showhelp.html">ShowHelp</a>.
Приведенный выше кусок теперь будет выглядеть так:
</p>
<pre class=code>HANDLE WINAPI _export OpenPlugin(int OpenFrom,int Item)
{
  <a href="../winapi/input_record.html">INPUT_RECORD</a> rec;
  BOOL done=FALSE;
  ...
  while (!done)
  {
    <b>Info.<a href="../service_functions/editorcontrol.html">EditorControl</a>(ECTL_READINPUT,&amp;rec);</b>
    ...
    if (rec.Event.KeyEvent.wVirtualKeyCode == VK_F1 &amp;&amp;
        rec.Event.KeyEvent.bKeyDown)
    {
      // <em>вызываем нужный хелп...</em>
      Info.<b>ShowHelp</b>(Info.ModuleName,<b>&quot;Navigate&quot;</b>,0);
    }
    ...
  }
  ...
}</pre>
<p>Почувствуйте разницу (естественно About-диалог не создаем)...</p>

<p class=plain>
Вот теперь действительно - Будьте проще.<br>&nbsp;<br>
</p>

<div align=right><code>
<br>&nbsp;<br>
14.10.1999<br>
Rev. 21.07.2000
</code></div>
<div class=seecont><a href="#top">наверх</a></div>

</body>
</html>