<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>Плагин для разных версий FAR Manager</title>
<meta http-equiv="Content-Type" Content="text/html; charset=utf-8">
<link rel="stylesheet" type="text/css" href="../../styles/styles.css">
<LINK REV=made href="mailto:eugene_yavorsky@mail.ru">
<META NAME="Author" content="Eugene Yavorsky">
<meta name="description" content="Плагин для разных версий FAR Manager.">
<script language="JavaScript" src='../links.js' type="text/javascript"></script>
</head>
<body>

<a name="top"></a>
<h1>Плагин для разных версий FAR Manager.</h1>
<h5>(замечания к статье <a href="version.html">FAR Group</a>)</h5>
<div class=navbar>
<a href="../index.html">главная</a> |
<a href="index.html">статьи</a>
</div>

<div align=right>
<code>Eugene Yavorsky <a href="mailto:Eugene%20Yavorsky%20<eugene_yavorsky@mail.ru>?subject=Articles">
<img src="../../images/email.gif" border="0" alt="[eugene_yavorsky@mail.ru]" width="16" height="16" align="middle">eugene_yavorsky@mail.ru</a>
</code></div>
<hr color="#003399">


<p class=plain>Озаботившись проблемой работы моего плагина в различных
версиях ФАРа, от лени не стал изобретать велосипеды и попытался вставить
готовую "козу" из упомянутой выше статьи (<a href="version.html">"Плагин для разных версий FAR Manager"</a> FAR Group),
однако код работал как-то странно.
Написав по его просьбе тестовый плагин (по приведенному коду - после исправления опечаток) и
протестировав его, получил следующие результаты.</p>

<p class=plain>Сборка плагина производилась с версиями plugin.hpp из поставки публичных бет:</p>
<ul>
  <li>1.70 beta 1 - Revision: 1.67 04.11.2000</li>
  <li>1.70 beta 2 build 312 - Revision: 1.70 16.12.2000</li>
  <li>1.70 beta 3 build 591 - Revision: 1.95 19.04.2001</li>
  <li>1.70 beta 4 build 1282 - Revision: 1.191 13.03.2002</li>
  <li>1.70 beta 5 build 1634 - Revision: 1.226 09.04.2003</li>
</ul>
<p class=plain>А также с plugin.hpp от какой-то 6-й альфы, не помню где взятым:</p>
<ul>
  <li>1.70 beta 6 build 1706 - Revision: 1.234 18.09.2003</li>
</ul>
<p class=plain>Далее эти версии plugin.hpp будут мною для простоты нумероваться как 1701, 1702, 1704, 1705 и 1706.</p>


<p class=plain>Тестирование проводилось в следующих публичных версиях ФАРа:</p>
<ul>
  <li>1.60</li>
  <li>1.63</li>
  <li>1.70 beta 1</li>
  <li>1.70 beta 2 build 312</li>
  <li>1.70 beta 3 build 591</li>
  <li>1.70 beta 4 build 1282</li>
  <li>1.70 beta 5 build 1634</li>
</ul>
<p class=plain>И двух 6-х альфах:</p>
<ul>
  <li>1.70 alpha 6 build 1658</li>
  <li>1.70 alpha 6 build 1736</li>
</ul>

<p class=plain>Для ФАРов 1.60 и 1.65 поведение всех версий плагина не отличалось:</p>
<ol>
  <li><a href="../exported_functions/getminfarversion.html">GetMinFarVersion()</a> не вызывается по причине отсутствия его в этих версиях FAR API</li>
  <li><a href="../exported_functions/getplugininfo.html">GetPluginInfo()</a> "видит", что
  <pre class=code>
     ::Info.StructSize < sizeof(struct PluginStartupInfo)</pre>
  и матерится при каждом вызове (т.е. при каждом F11, вызове меню настроек плагинов, смене языка и т.д.)</li>
</ol>

<p class=plain>Для ФАРов 1.701-1.706 build 1736</p>

<p class=plain>На основании логов проверено фунциклирование <dfn>GetMinFARVersion()</dfn>.
По горизонтали всех таблиц - версия ФАРа, по вертикали - версия plugin.hpp</p>

<p class=plain><B>-</B> ФАР не ругается на "плохую" версию плагина (а надо бы)</p>
<p class=plain><B>+</B> ФАР ругается на "плохую" версию плагина</p>
<p class=plain><B>.</B> ФАР не ругается на "плохую" версию плагина - и не надо</p>

<TABLE border=0>
  <TR>
    <TH align=left>Версия plugin.hpp</TH>
    <TH align=left>1701</TH>
    <TH align=left>1702</TH>
    <TH align=left>1703</TH>
    <TH align=left>1704</TH>
    <TH align=left>1705</TH>
    <TH align=left>1706 build 1658</TH>
    <TH align=left>1706 build 1736</TH>
  </TR>
  <TR>
    <TD align=center>1701</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
  </TR>
  <TR>
    <TD align=center>1702</TD>
    <TD align=center>-</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
  </TR>
  <TR>
    <TD align=center>1703</TD>
    <TD align=center>-</TD>
    <TD align=center>-</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
  </TR>
  <TR>
    <TD align=center>1704</TD>
    <TD align=center>-</TD>
    <TD align=center>-</TD>
    <TD align=center>-</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
  </TR>
  <TR>
    <TD align=center>1705</TD>
    <TD align=center>-</TD>
    <TD align=center>-</TD>
    <TD align=center>-</TD>
    <TD align=center>+</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
  </TR>
  <TR>
    <TD align=center>1706</TD>
    <TD align=center>-</TD>
    <TD align=center>-</TD>
    <TD align=center>-</TD>
    <TD align=center>+</TD>
    <TD align=center>+</TD>
    <TD align=center>+</TD>
    <TD align=center>.</TD>
  </TR>
</TABLE>

<p class=plain>При анализе логов для ФАРов 1701-1703 вообще нет свидетельств
о вызове <dfn>GetMinFARVersion()</dfn>.</p>

<p class=plain>Т.о., ФАР и <dfn>GetMinFARVersion()</dfn> ведет себя документированным
и предполагаемым образом только в ФАРах 1704 и выше.</p>

<hr>

<p class=plain>После титанических интеллектуальных усилий код был поправлен следующим образом:</p>

<pre class=code>

// Ставим тут нужную нам версию
#define HPPVER "1.705"

BOOL bBadFAR = FALSE;
DWORD dwFARVERSION;

void WINAPI SetStartupInfo(struct PluginStartupInfo *PSInfo)
{
  if(PSInfo->StructSize < sizeof(struct PluginStartupInfo))
  {
    memcpy(&Info,PSInfo,PSInfo->StructSize);
    bBadFAR = TRUE;
  }else{
    Info = *PSInfo;
    FSF = *PSInfo->FSF;
    Info.FSF = &FSF;

    Info.AdvControl(Info.ModuleNumber, ACTL_GETFARVERSION, &dwFARVERSION);
    if(dwFARVERSION < FARMANAGERVERSION)
      bBadFAR = TRUE;
  }

  if(bBadFAR)
      Message("Этот плагин требует FAR Manager версии "HPPVER" и выше!");
}

int WINAPI GetMinFarVersion(void)
{
  return FARMANAGERVERSION;
}

void WINAPI GetPluginInfo(struct PluginInfo *Info)
{
  if(bBadFAR)
    return;

  // Далее пошла инициализация PluginInfo
}
</pre>


<p class=plain>После тестирования по той же программе получаем:</p>


<p class=plain>Для ФАРов 1.60-1.65:</p>
<ol>
  <li><dfn>GetMinFarVersion()</dfn> не вызывается по причине отсутствия</li>
  <li><dfn>SetStartupInfo()</dfn> видит, что
<pre class=code>
     ::Info.StructSize < sizeof(struct PluginStartupInfo)</pre>
   и устанавливает bBadFAR = TRUE и один раз матерится</li>
  <li><dfn>GetPluginInfo()</dfn> в ответ на bBadFAR = TRUE сваливает без заполнения
   <a href="../structures/plugininfo.html">PluginInfo</a> и плагин не светится в списке</li>
</ol>

<p class=plain>Для ФАРов 1.701-1.706 build 1736</p>

<p class=plain>Обозначения:</p>

<p class=plain><B>+</B>ФАР ругается на "плохую" версию плагина (что достигается корректной работой <dfn>GetMinFarVersion()</dfn>)</p>
<p class=plain><B>#</B>плагин ругается на "плохую" версию ФАРа (что
достигается наличием в <a href="../exported_functions/setstartupinfo.html">SetStartupInfo()</a>):
<pre class=code>
  Info.AdvControl(Info.ModuleNumber, ACTL_GETFARVERSION, &dwFARVERSION);
  if(dwFARVERSION < FARMANAGERVERSION){
    bBadFAR = TRUE;
    Message("Этот плагин требует FAR Manager версии "HPPVER" и выше!");
  }</pre>

При этом <dfn>GetPluginInfo()</dfn> в ответ на bBadFAR = TRUE сваливает без заполнения <dfn>PluginInfo</dfn> и плагин не светится в списке.</p>

<p class=plain><B>+</B> <dfn>GetPluginInfo()</dfn> заполняет <dfn>PluginInfo</dfn>, плагин в списке и работает.</p>

<TABLE border=0>
  <TR>
    <TH align=left>Версия plugin.hpp</TH>
    <TH align=left>1701</TH>
    <TH align=left>1702</TH>
    <TH align=left>1703</TH>
    <TH align=left>1704</TH>
    <TH align=left>1705</TH>
    <TH align=left>1706 build 1658</TH>
    <TH align=left>1706 build 1736</TH>
  </TR>
  <TR>
    <TD align=center>1701</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
  </TR>
  <TR>
    <TD align=center>1702</TD>
    <TD align=center>#</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
  </TR>
  <TR>
    <TD align=center>1703</TD>
    <TD align=center>#</TD>
    <TD align=center>#</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
  </TR>
  <TR>
    <TD align=center>1704</TD>
    <TD align=center>#</TD>
    <TD align=center>#</TD>
    <TD align=center>#</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
  </TR>
  <TR>
    <TD align=center>1705</TD>
    <TD align=center>#</TD>
    <TD align=center>#</TD>
    <TD align=center>#</TD>
    <TD align=center>+</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
    <TD align=center>.</TD>
  </TR>
  <TR>
    <TD align=center>1706</TD>
    <TD align=center>#</TD>
    <TD align=center>#</TD>
    <TD align=center>#</TD>
    <TD align=center>+</TD>
    <TD align=center>+</TD>
    <TD align=center>+</TD>
    <TD align=center>.</TD>
  </TR>
</TABLE>

<p class=plain>Т.о., получаем необходимую и логичную функциональность для всех
протестированных версий ФАРа и plugin.hpp.</p>

<p class=plain>Полные версии тестировочных плугинов (старого - "неправильного"
и нового - "поправленного") и соответствующих логов есть на <a href="http://plugring.farmanager.com/downld/files/devel/version_testing.rar">PlugRin`е</a> и
будут лежать еще <a href="http://www.i.com.ua/~olg_eug/far/version_testing.rar">тут.</a> </p>


<div align=right><code>
<br>&nbsp;<br>
15.05.2004<br>
</code></div>

<p class=note><img src="../../images/note.gif" alt="Внимание!" width="10" height="10"> Внимание!</p>
<UL class=note><LI>Некорректно делать сравнение типа "<code>if(dwFARVERSION < FARMANAGERVERSION)</code>".
Это связано с тем, как FAR <a href="../exported_functions/getminfarversion.html">хранит</a> версию.
Необходимо сравнить старшую и младшую компоненты версии, например:
<pre class=code>if (LOWORD(dwFARVERSION) &lt;  LOWORD(FARMANAGERVERSION) ||
   (LOWORD(dwFARVERSION) == LOWORD(FARMANAGERVERSION) &amp;&amp;
    HIWORD(dwFARVERSION) &lt;  HIWORD(FARMANAGERVERSION)))
{
  bBadFAR = TRUE;
}
</pre>
</LI></UL>

<div class=seecont><a href="#top">наверх</a></div>

</body>
</html>