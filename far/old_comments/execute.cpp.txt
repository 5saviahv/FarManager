/*
Modify:
  17.07.2006 AY
    - прошлым фиксом испортил работу плагинов которые ожидали именно / для CD
  07.07.2006 AY
    - не работал CD когда в пути был /
    - для запуска в Win9x всегда выставляем пути пасивной панели
  04.07.2006 IS
    - warnings
  04.07.2006 SVS
    + Opt.ExecuteFullTitle
  03.07.2006 SVS
    - Mantis#0000204: Не всегда запускается проводник на папке по Shift-Enter
     (теперь, . ShiftEnter)
  30.06.2006 SVS
    ! Mantis#204 - небольшие недоделки.
  29.06.2006 SVS
    ! Bath -> Batch
    ! Execute + доп параметр (Mantis#204)
  28.06.2006 SVS
    + IsBathExtType(), BathFileExist()
  23.04.2006 AY
    - Execute() не выставлял путь пассивной панели для правильной работы driveletter: путей в win9x.
  31.03.2006 SVS
    - Некорректная работа команд CD и CHDIR с переменными среды.
  25.03.2006 AY
    - %var% не обрабатывались вообще в параметрах ком строки
  05.12.2005 AY
    ! Не совсем правильная обработка кавычек в CommandLine::ProcessOSCommands для CD/CHDIR
  14.07.2005 AY
    - теперь в заголовке окна (по Enter и ShiftEnter) показываем всегда то что запускает фар
      (путь к файлу и параметры без %comspec% /c).
    - при запуске в отдельном окне NewCmd* перекодировался в Char но не перекодировался
      назад в OEM после запуска, что приводило к неправильному показу имени файла в сообщении
      об ошибке.
  14.07.2005 SVS
    - Грязный хак в исполняторе против CtrlEnter ShiftEnter (см. 02025.Mix.txt)
  05.07.2005 SVS
    - ошибка в обработчике "cd" (когда применялась маска)
  05.04.2005 AY
    - Это не правильно (предыдущий фикс), надо убирать только первый пробел,
      что теперь и делает PartCmdLine.
  05.04.2005 SVS
    - Ctrl-G "echo L:\Foo\Bar" приводит к "echo  L:\Foo\Bar", т.е. добавляется доп.пробел между "echo" и "L"
  05.04.2005 AY
    ! Добавил в Execute все описаные в cmd.exe /? символы которые
      надо дабл-квотить "&<>()@^|".
  03.04.2005 WARP
    ! Изменения в execut'оре на предмет работы в 9x
  28.03.2005 SVS
    - BugZ#1091 - Неполноценная команда cd
    + добавил обработку "cd ~" - переход в "свой" каталог. Сделал для себя :-)
  02.03.2005 WARP
    ! Открытие папок во Shift-Enter.
    ! Подстановка значения из реестра для lpVerb.
  26.02.2005 SVS
    ! если у CommandLine не выставлен флаг FCMDOBJ_LOCKUPDATEPANEL,
      то перерисовать панели.
    ! Для перерисовки панелей воспользуемся существующей функцией
      ShellUpdatePanels() - она более корректно отрисовывает панели.
  26.02.2005 WARP
    ! Переписал (пересобрал) функцию execute
  05.01.2005 SVS
    - нужно указывать скока мы ходим взять из реестра, а не "0"
  05.01.2005 WARP
    ! Временно убрал экранирование & и ^ в исполняторе.
  15.12.2004 WARP
    ! Поменял метод окавычивания ком. строки
  15.12.2004 SVS
    - BugZ#1119 -  Неправильный разбор cmd строки для запуска
  14.12.2004 WARP
    ! Немного поломал executor. (see 01875.Executor.txt)
  06.08.2004 SKV
    ! see 01825.MSVCRT.txt
  18.05.2004 SVS
    - BugZ#1077 - Падение при отсутствующей Win-ассоциации
  17.05.2004 SVS
    ! небольшие уточнение в запускаторе в порыве исправить падение на ассоциациях
  06.05.2004 SVS
    ! Кусок кода, разбивающий ком.строку на исполнятор и параметры вынесен в PartCmdLine()
  27.04.2004 SVS
    - BugZ#568 - Confusing message on wrong path in CHDIR in case of forward-slash delimiter
      Исправление не претендует на оригинальность - если первый раз для CD
      не получилось найти каталог, то влоб меняем все '/' на '\' и отдаем
      команду на откуп операционке.
      CommandLine::ProcessOSCommands() для CD возвращает -1, если нет каталога.
      Этим и будем пользоваться.
      Если что откатим.
  29.03.2004 SVS
    ! CHCP: сначала вызываем LocalUpperInit(), потом InitLCIDSort(), а не наоборот
  15.03.2004 SVS
    - не работает "C:\Program Files\Far\Far.exe" /p"C:\Program Files\Far\plugins"
      и вариации на эту тему (по Shift-Enter).
      Пока закомментил..., т.к. возможно повторение BugZ#752
  09.03.2004 SVS
    - SD> 2) окно far'a 102x37
      SD> запускаю батник с одной лишь строкой
      SD> if '%os%'=='Windows_NT' MODE CON: COLS=80 LINES=25
      VC-версия трапается
      BC-версия шнягу на экран выдает
      Проверим размеры окна и вызовем CtrlObject->CmdLine->CorrectRealScreenCoord()
  01.03.2004 SVS
    ! Обертки FAR_OemTo* и FAR_CharTo* вокруг одноименных WinAPI-функций
      (задел на будущее + править впоследствии только 1 файл)
  09.02.2004 SVS
    - BugZ#993 - перекрытие сообщения рамок меню (уточнение)
    - BugZ#752 - Проблемы Shift-Enter для UNC ресурсов с пробелами и без (уточнение)
  15.01.2004 SVS
    - BugZ#993 - перекрытие сообщения рамок меню
  08.01.2004 SVS
    + учтем опцию Opt.ExecuteShowErrorMessage и выведем текст на экран, а не в месагбоксе
  05.01.2004 SVS
    ! Уточнение запускатора (про "far.exe/?")
  05.01.2004 SVS
    - BugZ#1007 - Не передаются параметры прогам когда Executor\Type=1
  11.11.2003 SVS
    - Правки в Execute() по поводу Shift-Enter
  16.10.2003 SVS
    ! Если в ассоциациях нету "command" или этот параметр реестра
      пуст - не вызываем ShellExecuteEx().
      Так же добавлен флаг SEE_MASK_FLAG_NO_UI, чтобы ФАР выбывал сообщения
      (если что - убрать!).
  09.10.2003 SVS
    ! SetFileApisToANSI() и SetFileApisToOEM() заменены на SetFileApisTo() с параметром
      APIS2ANSI или APIS2OEM - задел на будущее
  06.10.2003 SVS
    - BugZ#955 - Alt-F9 + Mode CON: Lines=12
      Достаточно "получить" данные о размере консоли... иначе вылетаем
      в ScrBuf.FillBuf(), там ScrY неверное значение имеет
  26.09.2003 VVM
    ! При поиске файла сначала ищем по переменной PATH и только потом в остальных местах
  03.09.2003 SVS
    - bugz#933 - задолбал этот strcpy :-(
    + В CommandLine::ProcessOSCommands() добавлен закомментированный кусок
      ...вариант для "SET /P variable=[promptString]" - что бы не потерялось...
  02.09.2003 SVS
    ! уточнение кода возврата функции CheckFolder()
  31.07.2003 VVM
    ! Некорректное определение типа исполняемого файла.
  05.06.2003 SVS
    ! SetFarConsoleMode имеет параметр - нужно ли активировать буфер
  06.05.2003 SVS
    ! при смене кодовой страницы так же переинициализируем некоторое массивы
    ! попытка борьбы с синим фоном в 4NT при старте консоль
  17.03.2003 SVS
    - BugZ#831 - Неверный заголовок окна при запуске из командной строки
  06.03.2003 SVS
    - BugZ#678 - Незапуск .msi по Shift-Enter
    ! Закоментим _SVS
  25.02.2003 SVS
    ! Вернем "старое" поведение для выставление титла консоли, ибо строка
      "gzip foo.bar" намного понятнее выглядит, нежели "c:\usr\bin\gzip.EXE"
  20.02.2003 SVS
    ! Заменим strcmp(FooBar,"..") на TestParentFolderName(FooBar)
  26.01.2003 IS
    ! FAR_CreateFile - обертка для CreateFile, просьба использовать именно
      ее вместо CreateFile
  17.01.2003 VVM
    ! Косметика
  17.12.2002 VVM
    - BugZ#678 - Незапуск .msi по Shift-Enter (вторая часть!)
  11.12.2002 VVM
    - Opps. Уберем грязь от экспериментов...
  11.12.2002 VVM
    - Исправлен баг с запуском приложений из архивов с русским именем.
      Для ГУИ будем пользовать ShellExcuteEx()
  04.10.2002 VVM
    ! Небольшой баг при поиске файла по списку расширений. Перед поиском расширения
      отделим имя файла от пути к нему.
  03.10.2002 VVM
    + Default action может содержать несколько команнд через запятую.
    + При поиске в App paths учтем кавычки и переменные окружения.
  20.09.2002 SKV
    | Отключил cd net:server
  03.09.2002 SVS
    - BugZ#606 - не работают переменные окружения в ассоциациях
      не стояла проверка на символы ":\" для "распахнутой" строки...
  21.08.2002 SVS
    - Исправления 1493 патча. Сначала нужно в обязательном порядке проверить
      кей "open", а если его нету, то... что первое попадется ;-)
  17.08.2002 VVM
    + GetShellAction() - если нет "Default action",  то возьмем первую,
      у которой будет ключ "Command"
  12.08.2002 SVS
    + Opt.ExecuteUseAppPath
  08.08.2002 VVM
    ! Вернем назад полный путь до текущего каталога.
  17.07.2002 VVM
    - Если пускаем из текущего каталога, то не делаем "развертку" пути.
    ! Команды из ExcludeCmds имеют ImageSubsystem == IMAGE_SUBSYSTEM_WINDOWS_CUI
    + Если ImageSubsystem == IMAGE_SUBSYSTEM_UNKNOWN, то детачим запускаемый процесс.
    - Плюс затычка для "\ Enter"
  15.07.2002 VVM
    + Для виндовс-ГУИ сделаем всегда запуск через ShellExecuteEx(). По идее SVS
  06.07.2002 VVM
    + Если не установлена переменная %COMSPEC% - предупредить и выйти.
  05.07.2002 SVS
    - ФАР ждет завершения GUI-прилад с NE-заголовком.
      Уточним этот факт (с подачи Andrzej Novosiolov <andrzej@se.kiev.ua>)
  19.02.2002 SVS
    - BugZ#558 - ShiftEnter из меню выбора диска
      Проверим так же на "корень диска" и выставим запуск через ShellExecuteEx()
  18.06.2002 SVS
    ! В обработчике команды "CD" (see CommandLine::ProcessOSCommands)
      посмотрим на CHKFLD_NOTACCESS (эту константу вернет нам та самая
      CheckFolder). Если все оби - едем дальше, иначе вернем FALSE и
      при этом ФАР матюкнется в консоль словами OS о том, что
      "Хреновый ты путь указал, малый. Отвали!".
      Тем самым реализуем ситуацию "пред-обработки", т.е. матюкаемся не
      тогда, когда ввалились в FileList::ReadFileNames, а... чуток пораньше! ;-)
      (эта побасенка про BugZ#513 - при cd на нечитаемую сетевую
      шару остаётся старое содержимое панели).
  14.06.2002 VVM
    + IsCommandPEExeGUI переделана. Теперь она возвращает не IsGUI битовый,
      а значения IMAGE_SUBSYSTEM_*
    + Переделана запускалка. Теперь в строке можно набрать "excel" и запустится ексель.
      Т.е. по реестру дополнительный поиск с расширениями из StdExecuteEx
  30.05.2002 SVS
    ! Для CHCP добавлен вызов InitRecodeOutTable().
  29.05.2002 SVS
    ! "Не справился с управлением" - откат IsLocalPath() до лучших времен.
  28.05.2002 SVS
    ! применим функцию  IsLocalPath()
  18.05.2002 SVS
    ! Возможность компиляции под BC 5.5
  10.05.2002 SVS
    + обработка CHCP
  17.04.2002 VVM
    ! Уточнение исполнятора.
  16.04.2002 DJ
    ! пропускаем встроенную обработку cd, если нажат Shift-Enter
  02.04.2002 SVS
    - BugZ#421 - Курсор в запускаемых программах
  30.03.2002 VVM
    ! Кавычим строку выполнения только если пускаем в отдельном окне.
  28.03.2002 SVS
    - CLS не выставляла атрибуты консоли
  26.03.2002 SVS
    - BugZ#393 - . Shift-Enter
  25.03.2002 VVM
    ! Очередная правка запускатора :)
  22.03.2002 IS
    - Устанавливали заголовок консоли крякозябрами, потому что не учили, что
      для 9x параметр у SetConsoleTitle должен быть в ANSI-кодировке
  21.03.2002 SVS
    - BugZ#365 - Глюк с открытием папок в проводнике по шифт+ентер
  20.03.2002 SVS
    ! GetCurrentDirectory -> FarGetCurDir
  20.03.2002 IS
    + "if [not] exist" дружит теперь с масками файлов
    ! PrepareOSIfExist теперь принимает и возвращает const
  18.03.2002 SVS
    ! Бадяга про курсор - там где нужно гасить, выставлялася 1
  28.02.2002 SVS
    - BugZ#318 - dot Shift-Enter
  26.02.2002 SVS
    ! "." и ".." по Shift-Enter рисуем AS IS, без модификации.
  19.02.2002 SVS
    ! В исполняторе юзаем только *ConsoleTitle, т.е. апишные...
  18.02.2002 SVS
    - set хрен=редька
      Сабжевая команда под cmd.exe работает правильно, а под фаром - отнюдь.
      Левая часть оказывается в неверной кодировке.
  15.02.2002 DJ
    - еще про заголовок: запускаем файл по ассоциации и видим, что через
      несколько секунд после запуска заголовок с нормального меняется
      на название запущенной программы
  14.02.2002 SVS
    - BugZ#300 - Shift-Enter на папке меняет путь заголовок окна
  14.02.2002 VVM
    ! UpdateIfChanged принимает не булевый Force, а варианты из UIC_*
  07.02.2002 SKV
    - Не надо при отрыве консоли менять её моду и т.д.
  04.02.2002 SVS
    - BugZ#289 Неправильно определяется GUI/Console для *.exe с русскими
      именами
  30.01.2002 SVS
    ! Проверим, а не папку ли мы хотим открыть по Shift-Enter?
      Если так, то вместо CreateProcess запустим ShellExe...
  28.01.2002 tran
    ! тройные кавычки нужны не всегда.
  18.01.2002 VVM
    ! Избавимся от setdisk() -> FarChDir()
  16.01.2002 SVS
    - Тот же самый BugZ#238. Немного увеличим буфера (до 4096 размер под FullPath)
  15.01.2002 SVS
    - Не исполняется "C:\Program Files\Far\Far.exe" "C:\Program Files\Far\Plugins"
  14.01.2002 IS
    ! chdir -> FarChDir
  24.12.2001 SVS
    - BugZ#193: не работает <, >, | (в 9х)
    + проверка на вшивость на подступах - если введено нечто вроде "|" или ">"
      или "<" (т.е. один символ) - то... в морг.
  21.12.2001 SVS
    - Bug: после запуска компилятора Java от MS, jvc.exe симолы псевдографики
           в пользовательском интерфейсе Far'а заменяются на русские буквы.
      Кстати, этим же страдают проги типа sh.exe (bash) из портированного
      унихового утилия.
  20.12.2001 SVS
    ! Для Shift-Enter учтем перенаправления и каналы.
  14.12.2001 IS
    ! stricmp -> LocalStricmp
  08.12.2001 SVS
    ! Уточнения в новом исполняторе - теперь вид шаблона исполнения задается
      по другому.
  07.12.2001 SVS
    ! Уточнения в новом исполняторе (их еще будет море ;-))
    ! Из CommandLine::CmdExecute() гашение панелей перенесено в RedrawDesktop
    ! В новом исполняторе введено понятие исклительных команд, которые,
      если попадаются, то не исполняются!
    ! DWORD* переделан в DWORD&
    ! У Execute команда (первый параметр) - const
  06.12.2001 SVS
    ! Откат к старому обработчику с возможностью работы с новым.
      Детельное описание читайте в 01104.Mix.txt
  05.12.2001 SVS
    - При определении ассоциации забыл "расширить" переменные среды :-(
  04.12.2001 SVS
    - забыл выделить имя модуля (не учитывались кавычки в активаторе)
  04.12.2001 SVS
    ! Очередное уточнение пусковика. На этот раз... при старте DOC-файлов
      ФАР ждет завершения. Выход из положения - "посмотрить" на гуевость
      пусковика.
  03.12.2001 SVS
    ! Уточнение для... пути со скобками :-)
    ! Новое поведение - убрали DETACHED_PROCESS и ждем завершение процесса.
  02.12.2001 SVS
    ! Неверный откат. :-(( Вернем все обратно, но с небольшой правкой,
      не будем изменять строку запуска, если явно не указано расширение, т.е.
      если вводим "date" - исполняется внутренняя команда ком.проц., если
      вводим "date.exe", то будет искаться и исполняться именно "date.exe"
      В остальном все должно быть как и раньше.
  30.11.2001 SVS
    ! Почти полный откат предыдущих наворотов с пусковиком
  29.11.2001 SVS
    - Бага с русскими буковками - забыли конвертнуть путь обратно в OEM.
  28.11.2001 SVS
    - BugZ#129 не запускаются программым с пробелом в названии
    ! небольшие уточнения в PrepareExecuteModule()
  22.11.2001 SVS
    - Как последний гад этот самый Екзекутеор валит ФАР на простой формуле:
      >"" Enter
      Ок. Будем вылавливать еще на подходе.
    + У Execute() добавлен параметр - SetUpDirs "Нужно устанавливать каталоги?"
      Это как раз про ту войну, когда Костя "отлучил" кусок кода про
      установку каталогов. Это понадобится гораздо позже.
  21.11.2001 SVS
    ! Объединение и небольшое "усиление" кода пусковика, а так же
      переименование IsCommandExeGUI в PrepareExecuteModule (фактически
      новая функция). GetExistAppPaths удалена за ненадобностью.
  21.11.2001 VVM
    ! Очереднйо перетрях прорисовки при запуске программ.
  20.11.2001 SVS
    - BugZ#111 - для cd Це: скорректируем букву диска - сделаем ее Upper.
  20.11.2001 SVS
    ! Уточнение пусковика.
  19.11.2001 SVS
    + GetExistAppPaths() - получить если надо путь из App Paths
    ! Функция IsCommandExeGUI() вторым параметром возврпащает полный путь
      к наденному файлу
  15.11.2001 OT
    - Исправление поведения cd c:\ на активном панельном плагине
  14.11.2001 SVS
    - Последствия исправлений BugZ#90 - панели не обновлялись
  12.11.2001 SVS
    - BugZ#90: панель остается на экране
  12.11.2001 SVS
    ! откат 1033 и 1041 до лучших времен.
  08.11.2001 SVS
    - неудачная попытка (возможно и ЭТОТ патч неудачный) запуска (про каталоги)
  31.10.2001 VVM
    + Попытка переделать запуск программ. Стараемся пускать не через "start.exe",
      а через CREATE_NEW_CONSOLE
  10.10.2001 SVS
    + Создан
*/
