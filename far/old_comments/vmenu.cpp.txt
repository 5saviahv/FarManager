/*
Modify:
  05.07.2006 IS
    - warnings
  30.01.2006 SVS
    - Memory Леак.
  07.12.2005 SVS
    + MACRO_USERMENU
  05.10.2005 SVS
    + обработка KEY_ALTLEFT и KEY_ALTRIGHT - для скроллинга хистори.
      Реализация только для текущего пункта истории
  24.07.2005 WARP
    ! see 02033.LockUnlock.txt
  14.06.2005 SVS
    - неучтенка ширины - про боттомтайтл забыли
  29.01.2005 WARP
    ! Небольшой cleanup (см. 01920.vmenu_dialog_cleanup.txt)
  27.12.2004 WARP
    ! Сделал критические секции при практически всех вызовах Dialog & VMenu
  12.12.2004 WARP
    ! Оптимизация с VMENU_DISABLEBACKGROUND не совсем удалась.
  08.12.2004 WARP
    ! Патч для поиска #1. Подробнее 01864.FindFile.txt
  01.12.2004 WARP
    ! Устраняем лишние перерисовки VMenu
  19.11.2004 WARP
    ! "Нормальная" реализация UpdateRequired для VMenu,
      более интеллектальное обновление листа в поске.
  11.11.2004 SVS
    + Обработка MCODE_V_ITEMCOUNT и MCODE_V_CURPOS
  27.08/2004 VVM
    - Некорректное исправление от 20.07.2004
      Перестало работать корректировка выделения при добавлении в пустой список.
  06.08.2004 SKV
    ! see 01825.MSVCRT.txt
  02.08.2004 SVS
    - BugZ#1144 - Непонятки c CheckHotkey
      Забыл учесть AmpPos
  20.07.2004 KM
    - Падение меню в AdjustSelectPos при SelectPos=-1
  08.07.2004 SVS
    + обработка MCODE_OP_PLAINTEXT в VMenu
  07.07.2004 SVS
    ! Macro II
  30.06.2004 SVS
    + CheckHighlights() - проверка "есть ли такой хоткей в меню"
      (в "обычном" ФАРе не работает, т.к. ограничена дефайном MACRODRIVE2)
    + Небольшая добавка по поводу Macro II
      (в "обычном" ФАРе не работает, т.к. ограничена дефайном MACRODRIVE2)
  31.05.2004 SVS
    ! выкинем нафиг MCODE_OP_SENDKEY - ненужен
  11.05.2004 SVS
    ! Вызов VMenu::ParentDialog->ProcessKey() в VMenu::ProcessKey уберем, т.к.
      в этом случае получаем зацикливание.
    + Из VMenu сделаем нотификацию DN_LISTHOTKEY для диалоговой процедуры.
  24.02.2004 SVS
    ! Проверка на макро USE_WFUNC
  19.02.2004 SVS
    - Некорретная отрисовка меню в W-режиме в связи с применением Text() вместо BoxText()
  19.01.2004 SVS
    ! уточнение VMENU_SELECTPOSNONE
  12.01.2004 SVS
    - падение в VMenu::GetUserData,  если GetPosition(Position) вернул -1
    - BugZ#1010 -   не работает DM_LISTGETCURPOS
  05.01.2004 SVS
    + VMENU_SELECTPOSNONE - признак того, что SelectPos не выставлен (например, все элементы списка задисаблены)
    ! Корректировка SelectPos (по флагу VMENU_SELECTPOSNONE)
  25.11.2003 SVS
    ! ConsoleTitle должен создаваться по мере надобности, а не в конструкторе
  05.11.2003 SVS
    + VMENU_CHANGECONSOLETITLE, OldTitle
  27.10.2003 SVS
    + В VMenu::AddItem() засунем критические секции
  23.10.2003 SVS
    + Обработка KEY_MACRO_EMPTY, KEY_MACRO_SELECTED, KEY_MACRO_EOF и KEY_MACRO_BOF
    ! VMenuCSection -> CSection
    ! вернем обратно вайлы и слипы
  14.10.2003 SVS
    + VMenuCSection
    ! цикл со счетчиком и Sleep(10) убраны в пользу критических секций
  06.10.2003 SVS
    - BugZ#966 - У диалога съезжает рамка при его перещении
      Для VMENU_LISTBOX не делаем операцию "X2=ScrX-2;"
  26.09.2003 SVS
    ! Изменения в названиях макроклавиш
  17.06.2003
   - Bug: теперь в плагинах заголовки на листах появляются только на
          пустых листах, а на листах с элементами - нет.
   - Bug: при удалении из DI_LISTBOX после 1663 курсор скакал на поз.0
          сделаем более правильное решение - вычислим "правильную" позицию
   ! Вместо CallCount++ и CallCount-- применим InterlockedIncrement(&CallCount)
     и InterlockedDecrement(&CallCount)
  27.05.2003 SVS
    + VMenu::DrawTitles() - кусок кода, прорисовывающий заголовки вынесен в
      эту функцию. Это бага про
      "DM_LISTSETTITLES не работает, если в листе ни одного элемента."
    - DI_LISTBOX, Bugs: "При удалении элементов списка, если курсор стоит
      не на удаляемом элементе, то курсоров становится 2"
      Здесь сбросим все селекты сразу после удаления и "пересчитаем"
      по новой.
  10.05.2003 SVS
    ! В VMenu::SortItems() добавлен третий параметр SortForDataDWORD,
      который заставляет делать сортировку только по UserData. По умолчанию
      = FALSE
    - Для ListBox не рисовалось поле (Box), если ItemCount=0
  06.04.2003 SVS
    - "...хоткей '-' не срабатывает в меню "Команды внешних модулей" (F11),
      если набирать на цифровой клавиатуре..."
  17.03.2003 SVS
    - BugZ#814 - DI_LISTBOX высотой 1 не отображается
    ! Подложка для DI_LISTBOX и DI_COMBOBOX рисуется цветом COL_*DIALOGLISTTEXT
    - очередные уточнения позиций
  04.02.2003 SVS
    - BugZ#788 - Криво считается ширина меню.
  30.01.2003 KM
    - Нашёл ещё причину падения фара в поиске. Как выяснилось
      это происходило в SetSelectPos, если SelectPos был равен -1.
  21.01.2003 SVS
    + xf_malloc,xf_realloc,xf_free - обертки вокруг malloc,realloc,free
      Просьба блюсти порядок и прописывать именно xf_* вместо простых.
  16.01.2003 KM
    ! Убрал свою правку, чтобы не загромождать код.
      После Валиной онп не имеет смысла (почти).
  13.01.2003 SVS
    - дополнение к двум предыдущим патчам :-)
  11.01.2003 KM
    - 100% падение фара в ShowMenu, скомпилированного VC, из
      диалога поиска при попытке отрисовки DI_LISTBOX.
  03.01.2003 SVS
    - Bug#757 - Несанкционированный доступ к настройкам
      (видимо не только в конструкторе нужно... надо подумать потом!!!)
  16.12.2002 SVS
    - BugZ#729 - некорректная отрисовка в диалоге найденных файлов
  04.11.2002 SVS
    - ListBox некорректно отрисовывается при отрисовки диалога,
      расположенного вплотную к по правому краю экрана
  29.10.2002 SVS
    ! скорректируем SelectPos после сортировки
  22.10.2002 SVS
    ! PrevCursorSize, PrevMacroMode - для пред.курсора
     > у меня сразу после выбора DrawLine из меню F11 пропадает курсор.
     > проявляется после практически любого нажатия на кнопки
  10.10.2002 SVS
    ! Уточнение BugZ#675.
  08.10.2002 SVS
    - BugZ#675 - Неправильно вычисляется ширина меню со списком окон
  04.10.2002 SVS
    ! Уточнение и расширение VMenu::SetColors()
  30.09.2002 SVS
    ! Цветовые истории (Colors не short, а BYTE и применим новую структуру
      FarListColors для SetColors/GetColors)
    ! небольшая оптимизация VMenu::SetColors
    - BugZ#400 - скролбар и проблемы из-за него
  20.09.2002 SVS
    - BugZ#635 - Плавающая ширина Plugin Configuration
    - BugZ#646 - Color groups\Dialog\*List* где они бывают?
  05.09.2002 SVS
    ! Уточнение BugZ#611
  03.09.2002 SVS
    - BugZ#611 - Нелепая сортировка в меню плагинов
    ! функция SortItems имеет доп параметр Offset
    - BugZ#601 - DM_LISTSETCURPOS & TopPos=-1
      Уточнение.
  27.08.2002 SVS
    - BugZ#601 - DM_LISTSETCURPOS & TopPos=-1
  25.06.2002 SVS
    ! Косметика:  BitFlags::Skip -> BitFlags::Clear
  18.06.2002 SVS
    ! В VMenu::Show() учтем факт того момента, что где-то когда то мы залочили
      отрисовку и... соответственно не станем делать эту саму отрисовку.
      Если этого не делать, то настырный манагер все равно отрисует менюху
      (даже если одна в состоянии Hide), при этом будем наблюдать (при выборе
      диска) визуальные противные эффекты (меню появилось, мать его).
      Эта побасенка про LockRefreshCount - в меню выбора дисков при извлечении
      CD-привода мы его (естественно меню :-) гасим и лочим.
  31.05.2002 SVS
    - BugZ#412 - bug в combobox'ах
  24.05.2002 SVS
    + Дублирование Numpad-клавиш
  18.05.2002 SVS
    - BugZ#517 - Пустое меню плагинов (и их конфигов) нельзя закрыть мышкой.
  18.05.2002 SVS
    - При апдейте данных в списке ЗАТИРАЛОСЬ ВСЕ!, потому то и нихрена не
      работало :-( Обновляем только те поля, которые нужно.
  18.05.2002 SVS
    ! MouseDown -> VMENU_MOUSEDOWN
  11.05.2002 SVS
    ! Меняем LIF_UPDATEKEEPUSERDATA на противоположный LIF_DELETEUSERDATA,
      делаем этот флаг доступным (соответственно меняется логика -
      при апдейте итема списка удаляем привязанные данные только в случае,
      если нас об этом попросили)
  28.04.2002 KM
    + GetTypeAndName возвращает тип MODALTYPE_VMENU и
      MODALTYPE_COMBOBOX.
  25.04.2002 SVS
    - BugZ#467 - Дублирующиеся хоткеи в Folders History
  18.04.2002 KM
    - Сбрасываем флаг "координаты установлены" у
      меню. Убивается баг:
      ===
      Новый прикол с DI_COMBOBOX
      3. Открывается (Ctrl-Down) и закрывается COMBOBOX (неважно как с
         выбором или по ESC).
      4. Теперь откравается EDIT (Ctrl-Down).
      5. Наблюдается глюк (открывшийся COMBOBOX).
      ===
  13.04.2002 KM
    - Добавим проверку на существование буфера сохранения,
      т.к. ResizeConsole вызывается теперь для всех экземпляров
      VMenu при AltF9.
  02.04.2002 SVS
    - BugZ#416 - Listbox with DIF_LISTNOBOX does not work correctly
  18.03.2002 SVS
    ! Про курсор
  03.03.2002 SVS
    ! Если для VC вставить ключ /Gr, то видим кучу багов :-/
  27.02.2002 SVS
    + LIF_UPDATEKEEPUSERDATA - "не убивать юзердату при обновлении"
    ! LIFIND_NOPATTERN -> LIFIND_EXACTMATCH
  23.02.2002 DJ
    - не перерисовывалось меню после DM_LISTDELETE (NULL)
    ! Show() также использует флаг VMENU_LISTHASFOCUS
    - после DM_LISTDELETE не ставим текущую позицию на сепаратор
    - VMenu::GetTitle() неправильно возвращало пустой заголовок
    - скорректирован алгоритм обрезания длинных заголовков меню
    - обработка LIF_SELECTED в UpdateItem
    - маскировка внутренних флагов в GetVMenuInfo
  21.02.2002 DJ
    ! корректная отрисовка списков, не имеющих фокуса
    - зависание, если в меню без WRAPMODE последний элемент - сепаратор
    + функция корректировки текущей позиции в меню
  19.02.2002 SVS
    - Забыли про Disable для хоткеев и акселераторов
  18.02.2002 SVS
    - Неверный расчет AmpPos
  13.02.2002 SVS
    ! Немного оптимизации...
    + Один интересный повторяющийся кусок вынесен в CheckKeyHighlighted()
    + MIF_USETEXTPTR - щоб юзать TextPtr
  11.02.2002 SVS
    + Член AccelKey в MenuData и MenuItem
    + BitFlags
    ! у функции UpdateItem() параметр должен быть типа FarListUpdate
    ! Сепаратор может иметь лэйб
  26.12.2001 SVS
    - если все пункты задисаблены, то нефига показывать селектед-пункт
      цветом курсора.
  21.12.2001 SVS
    - не учитывался флаг VMENU_LISTBOX при пересчете координат, из-за чего
      нельзя было спозиционировать список в X1=0
  02.12.2001 KM
    + Поелику VMENU_SHOWAMPERSAND сбрасывается в AssignHighlights
      для корректной работы ShowMenu сделаем сохранение энтого флага
      в переменной VMOldFlags, в противном случае если в диалоге
      использовался DI_LISTBOX без флага DIF_LISTNOAMPERSAND, то
      амперсанды отображались в списке только один раз до следующего
      ShowMenu.
  30.11.2001 DJ
    - не забудем инициализировать MaxLength
  14.11.2001 SVS
    ! Уточнение позиционирования при TopPos=-1 - возможно ошибся
  12.11.2001 SVS
    ! Небольшие уточнения.
  06.11.2001 SVS
    ! VMENU_REVERSIHLIGHT -> VMENU_REVERSEHIGHLIGHT
    ! struct FarListInsert.
         Если Index больше текущего количества элементов списка, то
         вставляемый пункт будет добавлен в конец списка.
         Если Index меньше нуля, то вставляемый пункт будет добавлен
         в начало списка.
  05.11.2001 SVS
    ! немного комментариев-разъяснений по поводу "прикрепленных" данных
  01.11.2001 SVS
    + немного про "типы" - GetType*()
  30.10.2001 SVS
    - Ошибка инженерной мысли :-) в VMenu::FindItem() - забыли передать
      флаги.
  13.10.2001 VVM
    ! Теперь меню не реагирует на отпускание клавиши мышки, если клавиша была нажата не в меню.
  12.10.2001 VVM
    ! Исправление ситуации со скроллбаром в DROPDOWNLIST-е
  10.10.2001 IS
    ! внедрение const
  27.09.2001 IS
    - Левый размер при использовании strncpy
  16.09.2001 SVS
    - BugZ#26: Динамическое изменение ширины списка истории
      (не вычищенные остатки предыдущих испытаний :-)
  12.09.2001 SVS
    - BugZ#10: F6, Ctrl-Down - "курсор" стоит не на верхней строке.
               Так и должно быть? Мне кажется - нет, должен "предлагаться"
               последний вариант из списка.
  09.09.2001 SVS
    ! Очредное уточнение на размер меню (вроде от глюков избавились!)
  05.09.2001 SVS
    ! небольшое уточнение на размер меню (вроде от глюков избавились?)
  14.08.2001 SVS
    ! уточнение пересчета координат при автоцентировании
  07.08.2001 SVS
    - неверно в прошлой серии велся пересчет координат.
  06.08.2001 SVS
    - бага с MaxLength - небыло контроля на длину титла
  01.08.2001 KM
    ! Ещё однго небольшое исправление.
      Добавлен инкремент/декремент CallCount
      в ShowMenu.
  31.07.2001 SVS
    ! Небольшое исправление (с подачи KM)
    ! MACRO_OTHER -> MACRO_MENU
  26.07.2001 OT
    - Поправлен ResizeConsole()
  26.07.2001 SVS
    ! VFMenu уничтожен как класс
  22.07.2001 KM
    ! Исправление неточности перехода по PgUp/PgDn
      с установленным флагом VMENU_SHOWNOBOX (NO_BOX)
  22.07.2001 KM
    - Не устанавливался тип рамки при первом вызове
      ShowMenu с параметром TRUE, что давало неверную
      отрисовку меню.
  21.07.2001 KM
    ! Переработка отрисовки меню с флагом VMENU_SHOWNOBOX.
    ! Переработка обработки мыши в меню с флагом VMENU_SHOWNOBOX.

      Теперь DI_LISTBOX с выставленным флагом DIF_LISTNOBOX и меню
      с флагом VMENU_SHOWNOBOX рисуются без лишних окантовывающих пробелов
      вокруг списка, что автоматически позволяет использовать DI_LISTBOX в
      диалогах, не опасаясь затирания рамки самого диалога пустым местом от
      списка.
  19.07.2001 OT
    - VFMenu - продолжение исправления
  18.07.2001 OT
    + Новый класс VFMenu
  11.07.2001 SVS
    + Shift-F1 на равне с F1 может вызывать хелп. Это на тот случай, если мы
      в качестве хоткея назначили F1 (естественно хелп в такой ситуации не
      будет вызываться)
  30.06.2001 KM
    ! Языковое уточненение: LIFIND_NOPATTER -> LIFIND_NOPATTERN
    + GetSelectPos(struct FarListPos *)
    + SetSelectPos(struct FarListPos *)
    ! Небольшое изменение в функции UpdateRequired: теперь она возвращает
      TRUE и при условии, что выставлен флаг VMENU_UPDATEREQUIRED
  29.06.2001 SVS
    + Новый параметр у FindItem - флаги
    + LIFIND_NOPATTER - точное (без учета регистра букв) соответствие при
      поиске в списке
  25.06.2001 IS
    ! Внедрение const
  14.06.2001 SVS
    - Установка позиции всегда приводит к выбору 0 итема.
  13.06.2001 SVS
    - приведение типов.
  12.06.2001 KM
    - Некорректно работала функция GetUserData. Забыли, что данные
      в меню могут храниться не в UserData, а просто в Name, из-за
      чего не работал выбор из комбобокса (выбирался мусор).
  10.06.2001 SVS
    + FindItem с двумя параметрами - для будущего ручного финдера в списке.
    - не работал поиск, т.к. присутствовали символы '&'
  05.06.2001 KM
    - Избавление от маленькой дырочки в Set*Title.
  04.06.2001 SVS
    - Злостная бага в DeleteItem :-(
  04.06.2001 SVS
    ! "Фигня с пацанами вышла" - это про патч 706. В общем уточнения функций.
  03.06.2001 KM
    + Функции SetTitle, GetTitle, GetBottomTitle.
    ! Вернём DI_LISTBOX'у возможность задавать заголовок.
    ! Убрана дефолтная установка флага VMENU_WRAPMODE, в противном
      случае при создании меню прокрутка работала _ВСЕГДА_, что
      не всегда удобно.
  03.06.2001 SVS
    ! Изменения в связи с переделкой UserData в VMenu
    + GetPosition() - возвращает реальную позицию итема.
    + GetUserDataSize() - получить размер данных
    + SetUserData() - присовокупить данные к пункту меню
    ! GetUserData() - возвращает указатель на сами данные
  30.05.2001 OT
    - Проблемы с отрисовкой VMenu. В новом члене Frame *FrameFromLaunched
      запоминается тот фрейм, откуда это меню запускалось.
      Чтобы потом он не перерисовавался, когда его не просят :)
  25.05.2001 DJ
    + SetColor()
  23.05.2001 SVS
    - Проблемы с горячими клавишами в меню (Part II) - ни тебе инициализации
      AmpPos при добавлении пунктов, да еще и разницу между имененм и
      позицией... Срань.
  23.05.2001 SVS
    - Проблемы с горячими клавишами в меню.
  22.05.2001 SVS
    ! Не трогаем оригинал на предмет вставки '&', все делаем только при
      прорисовке.
  21.05.2001 DJ
    - Забыли вернуть значение в VMenu::ChangeFlags()
  21.05.2001 SVS
    ! VMENU_DRAWBACKGROUND -> VMENU_DISABLEDRAWBACKGROUND
    ! MENU_* выкинуты
    ! DialogStyle -> VMENU_WARNDIALOG
    ! struct MenuData
      Поля Selected, Checked и Separator преобразованы в DWORD Flags
    ! struct MenuItem
      Поля Selected, Checked, Separator и Disabled преобразованы в DWORD Flags
  18.05.2001 SVS
    ! UpdateRequired -> VMENU_UPDATEREQUIRED
    ! DrawBackground -> VMENU_DRAWBACKGROUND
    ! WrapMode -> VMENU_WRAPMODE
    ! ShowAmpersand -> VMENU_SHOWAMPERSAND
    + Функции InsertItem(), FindItem(), UpdateRequired(), GetVMenuInfo()
  17.05.2001 SVS
    + UpdateItem() - обновить пункт
    + FarList2MenuItem() \ функции преобразования "туда-сюда"
    + MenuItem2FarList() /
    ! табуляции меняем только при показе - для сохранение оригинальной строки
    ! При автоназначении учтем факт того, что должны вернуть оригинал не тронутым
  15.05.2001 KM
    - Не работал флаг DIF_CHECKED в DI_LISTBOX
    + Добавлена возможность назначать в DI_LISTBOX с флагом DIF_CHECKED
      произвольный символ (в младшем слове Flags), который будет
      использоваться в качестве Check mark, следующим образом:
      MacroMenuItems[i].Flags|=(S[0]=='~')?LIF_CHECKED|'-':0;
  12.05.2001 SVS
    + AddItem(char *NewStrItem);
  07.05.2001 SVS
    ! SysLog(); -> _D(SysLog());
    + AddItem, отличается тем, что параметр типа struct FarList - для
      сокращения кода в диалогах :-)
    + SortItems() - опять же - для диалогов
    * Изменен тип возвращаемого значения для GetItemPtr() и убран первый
      параметр функции - Item
  06.05.2001 DJ
    ! перетрях #include
  27.04.2001 VVM
    + Обработка KEY_MSWHEEL_XXXX
    + В меню нажатие средней кнопки аналогично нажатию ЕНТЕР
  09.04.2001 SVS
    ! Избавимся от некоторых варнингов
  20.02.2001 SVS
    + Добавлена функция SetSelectPos() - переместить курсор с учетом
      Disabled & Separator
    ! Изменения в клавишнике и "мышнике" :-) с учетом введения SetSelectPos()
    ! Символы, зависимые от кодовой страницы
      /[\x01-\x08\x0B-\x0C\x0E-\x1F\xB0-\xDF\xF8-\xFF]/
      переведены в коды.
    ! Оптимизирован механизм отображения сепаратора - сначала формируем в
      памяти, потом выводим в виртуальный буфер
  11.02.2001 SVS
    ! Несколько уточнений кода в связи с изменениями в структуре MenuItem
  11.12.2000 tran
    + прокрутка мышью не должна врапить меню
  20.09.2000 SVS
    + Функция GetItemPtr - получить указатель на нужный Item.
  29.08.2000 tran 1.09
    - BUG с не записью \0 в конец строки в GetUserData
  01.08.2000 SVS
    + В ShowMenu добавлен параметр, сообщающий - вызвали ли функцию
      самостоятельно или из другой функции ;-)
    - Bug в конструкторе, если передали NULL для Title
    ! ListBoxControl -> VMFlags
    + функция удаления N пунктов меню
    + функция обработки меню (по умолчанию)
    + функция посылки сообщений меню
    ! Изменен вызов конструктора для указания функции-обработчика и родителя!
  28.07.2000 SVS
    + Добавлены цветовые атрибуты (в переменных) и функции, связанные с
      атрибутами:
      SetColors();
      GetColors();
  23.07.2000 SVS
    + Куча рамарок в исходниках :-)
    ! AlwaysScrollBar изменен на ListBoxControl
    ! Тень рисуется только для меню, для ListBoxControl она ненужна
  18.07.2000 SVS
    ! изменен вызов конструктора (пареметр isAlwaysScrollBar) с учетом
      необходимости scrollbar в DI_COMBOBOX (и в будущем - DI_LISTBOX)
  13.07.2000 SVS
    ! Некоторые коррекции при использовании new/delete/realloc
  11.07.2000 SVS
    ! Изменения для возможности компиляции под BC & VC
  06.07.2000 tran
    + mouse support for menu scrollbar
  29.06.2000 SVS
    ! Показывать ScrollBar в меню если включена опция ShowMenuScrollbar
  28.06.2000 tran
    + вертикальный скролбар в меню при необходимости
  25.06.2000 SVS
    ! Подготовка Master Copy
    ! Выделение в качестве самостоятельного модуля
*/
