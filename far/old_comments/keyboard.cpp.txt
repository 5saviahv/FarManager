/*
Modify:
  20.09.2006 SVS
    - Уточнение KeyNameToKey() - для переменной ала "%CtrlAltF1" отрабатывал... в общем кривизна была :-)
  05.07.2006 IS
    - warnings
  03.07.2006 SVS
    - Mantis#0000141: Неправильный ввод макросов AltShift/ и Alt- (Alt_)
  11.05.2006 SVS
    - Modif+Space давал на выходе 0. Т.с. недолеченный вариант про Dead Keys
  20.04.2006 SVS
    + Opt.UseVk_oem_x - часть I
  17.04.2006 SVS
    + логирование
    ! отвалятся макросы AltShift/ и AltShift*
      т.е. теперь они должны зваться как AltShiftDivide и AltShiftMultiply (и еже с ними)
  10.10.2005 SVS
    - Неправльно кубики сложил - Modif в CalcKeyCode() не там стояло и вычислялось по предыдущим значениям.
  13.09.2005 SVS
    + модификаторы для Spec-клавиш
  09.09.2005 SVS
    + Добавлены (в т.ч. и имена) KEY_F13..KEY_F24 и несколько MM клавиш с
      VK-кодами от A6 до B7.
    + Специфические клавиши, у которых виртуальный код отличен от 0xFF,
      но имена которых FAR не знает, будут хранится как "OemXXXXX"
      (здесь XXXXX десятичное значение виртуального кода клавиши с
      ведущими нулями).
    + Специфические клавиши, у которых виртуальный код равен 0xFF,
      будут хранится как "SpecXXXXX"
      (здесь XXXXX десятичное значение сканкода клавиши с ведущими нулями).
  07.07.2005 SVS
    ! окончание темы, начатой в патче 1742 (01742.CAS.txt) - TechInfo #68
  24.04.2005 AY
    ! GCC
  03.12.2004 SVS
    - BugZ#1196 - Повторное Shift-Enter...
  09.11.2004 SVS
    - Макросы. Если есть автостартующие макросы, то
      Far -r
      заваливается, т.к. файловые панели еще не созданы, соотвественно Cp() вернет NULL.
      Проверим так же, что там Cp() вернет.
  21.08.2004 SVS
    ! Коррекция CheckForEscSilent() на предмет "завершенности" макроса - это когда последним в макросе стоит KEY_NONE.
  06.08.2004 SKV
    ! see 01825.MSVCRT.txt
  31.05.2004 SVS
    ! выкинем нафиг MCODE_OP_SENDKEY - ненужен
    ! ReplaceStrings - последний параметр TRUE (не различать "высоту" букв)
  27.05.2004 SVS
    ! Для wVirtualKeyCode >= 0xFF возвращаем KEY_IDLE
  22.04.2004 SVS
    - BugZ#1061 - Ненадо учитывать CASE символов управляющих слов в записанных макросах в реестре
      вместо strstr() заюзаем новую функу LocalStrstri() - аналог strstr(), но с локалью и без учета регистра
  14.04.2004 SVS
    - "Ожил (или появился?) макрос"
  29.03.2004 SVS
    - Т.к. работаем в OEM + W-Input-функции, то... необходима перекодировка
      Unicode-символа из входного потока в OEM.
  01.03.2004 SVS
    ! Обертки FAR_OemTo* и FAR_CharTo* вокруг одноименных WinAPI-функций
      (задел на будущее + править впоследствии только 1 файл)
  18.12.2003 SVS
    ! Пробуем различать левый и правый CAS (попытка #1).
  24.10.2003 SVS
    ! уточнение FarNameToKey
  20.10.2003 SVS
    - преобразование Key = FarNameToKey ("AltCtrlБуква") -> FarKeyToName (Key) работает
      некорректно (возвращается Alt00000, вместо AltCtrlБуква
  15.10.2003 SVS
    + обработка вызова грабера при макросении
  13.10.2003 SVS
    ! RunGraber() вызываем в манагере, а в CalcKeyCode() просто вернем KEY_INS|KEY_ALT
  04.10.2003 SVS
    ! RunStartMacro() - "всегда"
  26.09.2003 SVS
    ! Изменения в названиях макроклавиш  25.07.2003 SVS
    ! учтем новые коды возврата для KeyMacro::GetCurRecord()
    ! учтем новый FARMACRO_KEY_EVENT в CalcKeyCode(), иначе плагины получат KEY_NONE
  17.06.2003 SVS
    - Alt-256 не давал нам символ с кодом 0x00. Пока закомментим кусочек один
  27.05.2003 SVS
    - Если CtrlObject->Macro.ProcessKey() вернул "УГУ", то обнулим EventType
      иначе все это барахло (имеется ввиду комбинация инициализации макроса)
      попрется в плагин, обрабатывающий ввод в редакторе.
    ! Вместо события "0x8001" применим осмысленный FARMACRO_KEY_EVENT
  23.05.2003 SVS
    ! Если макроклавиша - "обычная" клавиша, то...
       INPUT_RECORD.EventType=0x8001 - элемент Event содержит структуру
       KEY_EVENT_RECORD с информацией о сообщении с клавиатуры. Это
       сообщение специфичное для FAR manager (начиная с билда 1662) и
       приходит плагину во время "проигрывания" макрокоманды.
  06.05.2003 SVS
    ! очередные работы по DETECT_ALT_ENTER
  21.04.2003 SVS
    ! Автостартующие макросы запускаем только после загрузки всех плагинов!
    + Alt-Enter - пока в тестовой моде.
  05.03.2003 SVS
    ! Закоментим _SVS
  03.02.2003 SVS
    - BugZ#787 - Криво активируется QuickSearch при выполнении макроса.
  21.01.2003 SVS
    + xf_malloc,xf_realloc,xf_free - обертки вокруг malloc,realloc,free
      Просьба блюсти порядок и прописывать именно xf_* вместо простых.
  15.01.2003 SVS
    ! У FARGetKeybLayoutName первый параметр может быть NULL
  10.01.2003 SVS
    - "Доисправим" BugZ#488 - Shift=enter
      Если ЭТО был макрос и у него нету KEY_SHIFT, то обнулим ShiftPressed
  06.01.2003 SVS
    ! в GetInputRecord сделаем Discard буферу сохранения в GlobalSaveScrPtr
      при обработке эвента WINDOW_BUFFER_SIZE_EVENT
    + FARGetKeybLayoutName, которая вызывает недокументированную
      KERNEL32.DLL::GetConsoleKeyboardLayoutNameA
  11.12.2002 SVS
    - BugZ#702 - Не обрабатывается изменение размера консоли во время копирования
      ВНИМАНИЕ! В обработку WINDOW_BUFFER_SIZE_EVENT включен механизм редрайва
      фреймов и вызов функции PreRedrawFunc!!!
  10.12.2002 SVS
    - BugZ#695 - Не работает прерывание по Esc
    ! УБРАН SaveScreen в функции ConfirmAbortOp(). МЕШАЕТ!
  18.11.2002 SVS
    - FSF.FarNameToKey("aaa") возвращает вместо -1 0x40000000.
  09.11.2002 SVS
    ! В связи с коррекцией "ReturnAltValue" вводим в макросах понятие
      AltXXXXX - т.е. то, что было введено как Alt-Num. Для того, чтобы
      не конвертировать код клавиши в редакторе!
  04.11.2002 SVS
    ! ReturnAltValue уехала из keyboard.cpp в global.cpp
  18.09.2002 VVM
    + SheckForEscSilent() - проверить на ESC безо всяких запросов пользователя
    + CinfirmAbortOp()    - спросить у пользователя подтверждение прерывания
    ! Соответственно CheckForEsc() теперь состоит из пары этих функций
  16.09.2002 SVS
    - "При драгндропе ярлыка с рабюочего стола его путь вставляется не
       полностью - интересно, почему?"
  21.08.2002 SVS
    ! WaitKey теперь возвращает код нажатой клавиши
  19.08.2002 SVS
    + Аля SKV "Пусть KEY_CTRL тоже будет IsShiftKey" :)
      (про дополнения в "BugZ#579 - сбрасывание выделения")
  17.08.2002 SVS
    - Траблы с Alt-Digit + NumLock=On под масдайкой.
    - В масдае нажатие на Gray-Del всегда приводил к клавише Del, независимо
      от состояния NumLock (при включенном NumLock ожидаем '.', но ее в
      масдае нету).
    - Наконец-то удавил гадину масдаевскую, вставляющую шифты - масдай
      успевает подсовывать Shift в очередь при нажатии курсорных расширенных
      клавиш... В т.ч. и NT... - ну.. "это совсем другая история, страна" ;-)
  23.07.2002 SKV
    + Пусть KEY_ALT тоже будет IsShiftKey :)
  30.05.2002 SVS
    ! Технологический патч для USE_WFUNC_IN - пока только эксперименты
      (чтоб не потерялось :-))
  24.05.2002 SVS
    ! Внедрение Numpad.
    ! исправлена ситуация, когда для прочих событий в клавиатурнике
      делается приведения рекорда к KEY_EVENT без предварительной очистки
      структуры (от чего Autowrap и ему подобным - колбасит по полной
      программе)
  16.05.2002 SVS
    - Фигня с мышью (пред.патч). Закомментим до лучших времен
      (сразу и не заметил, т.к. на LeftAlt на было назначено макроса)
    ! USE_WFUNC -> USE_WFUNC_IN, т.к. это совсем другая история
      Т.е. вывод на экран - это одно, а вот ввод - совсем другое!
      Если с выводом более менее ясно, то здесь полный бардак.
  15.05.2002 SVS
    ! Уточнения в WriteInput (особенно про Key > 255 :-)
    + В обработчике мыши... сравним Ctrl-keys и... если надо дадим сигнал на
      прорисовку, путем засыла в очередь VK_F16
  14.05.2002 VVM
    - Если крутим колесо мыши, то сбрасываем тип события EventType;
  05.04.2002 SVS
    + Prev?ButtonPressed
  01.04.2002 SVS
    ! Вместо KEY_FOCUS_CHANGED заведем KEY_KILLFOCUS и KEY_GOTFOCUS.
  19.03.2002 SVS
    - BugZ#364 - alt+break
  12.03.2002 VVM
    + Задействуем функцию AbortMessage()
  20.02.2002 OT
    - BugZ#314 - Shift-Enter на папке меняет путь заголовок окна
  14.02.2002 VVM
    ! UpdateIfChanged принимает не булевый Force, а варианты из UIC_*
  05.02.2002 SVS
    ! технологический патч - про сислоги
    + SpecKeyName - доступно только при отладке (SysLog)
  04.02.2002 SVS
    + IsNavKey(), IsShiftKey()
  29.01.2002 SVS
    - Была неверная отложенная установка заголовка консоли (неверное,
      старое значение выставлялось)
  10.01.2002 SVS
    ! Устем правило Opt.HotkeyRules для Alt-буква
  27.12.2001 KM
    ! Обнулим KeyText в KeyToText (как и было раньше), в противном случае
      в буфере клавиши возвращался мусор!
  26.12.2001 SVS
    ! При закрытии окна "по кресту"... теперь настраиваемо!
  25.12.2001 SVS
    ! В режиме WaitInMainLoop=1 Alt-символ и Alt-Shift-символ транслируем как
      есть (чтобы корректно работал FastFind). В остальных случаях - берем
      абс.значения кода клавиши.
    ! немного оптимизации
  21.12.2001 SVS
    + DOUBLE_CLICK as Macro
  08.12.2001 SVS
    - Бага в KeyNameToKey() - например, для "ShiftFooBar" выдаст KEY_SHIFT,
      Лечится путем сравнения Pos и Len, т.е. в нормальной ситуации должно
      быть Pos == Len
  26.11.2001 SVS
    + MouseEventFlags, PreMouseEventFlags - типы эвентов мыши
  20.11.2001 SVS
    ! В обработку FOCUS_EVENT добавим также обнуление LButtonPressed,
      RButtonPressed и MButtonPressed
  15.11.2001 SVS
    - BugZ#66 - порча командной строки после двойного AltF9
      Добавив немного Sleep(1) избавляемся от бага...
  24.10.2001 SVS
    ! CheckForEsc() - нажатие Esc в диалоге равносильно нажатию кнопки Yes
      Плюс - запрещение Alt-F9 и скринсавер.
  21.10.2001 SVS
    + PrevScrX,PrevScrY - предыдущие размеры консоли (для позиционирования
      диалогов)
  15.10.2001 SVS
    + _KEYMACRO()
  11.10.2001 SVS
    - BugZ#79. Некоректное преобразование имен клавиш в коды (при ошибках в
      написании названия клавиш)
  20.09.2001 SVS
    - бага с Alt-цифровая клавиша.
    ! Параметр у InputRecordToKey "const"
  18.09.2001 SVS
    ! временно отменим "...теперь даже для макроса корректно заполняется..."
  14.09.2001 SVS
    - Бага в TranslateKeyToVK() - неверно формировалось поле для Shift-клавиш
    ! теперь даже для макроса корректно заполняется структура INPUT_RECORD
      в функции GetInputRecord()
  30.08.2001 IS
    ! При принудительном закрытии Фара пытаемся вести себя так же, как и при
      нажатии на F10 в панелях, только не запрашиваем подтверждение закрытия,
      если это возможно.
  24.07.2001 SVS
    ! Если ждем KEY_CTRLALTSHIFTRELEASE, то гасим курсор (!)
  23.07.2001 SVS
    - Не работала комбинация Alt (не отпуская, в панеля) sp_
      (не набирался симол подчеркивания при нажатой Alt)
  01.07.2001 KM
    - При отпускании Shift-Enter в диалоге назначения
      вылазил Shift после отпускания клавиш.
  28.06.2001 SVS
    - Для Win9x при нажатом NumLock и юзании курсорных клавиш
      получаем в диалоге назначения ерундистику.
  25.06.2001 IS
    ! Внедрение const
  23.06.2001 OT
    - far -r
  21.06.2001 SVS
    ! Удалена функция WriteSequenceInput() за ненадобностью
  14.06.2001 OT
    ! "Бунт" ;-)
  08.06.2001 SVS
    ! Исправление ситуации (влоб) с блокировкой мыши при запуске некоторых
      PE приложений!
    ! ENABLE_MOUSE_INPUT -> ENABLE_WINDOW_INPUT с подаче ER ;-)
  06.06.2001 SVS
    ! Уточнение в функции WriteInput - теперь wVirtualScanCode
      корректно транслируется.
    ! W-функции юзаем пока только в режиме USE_WFUNC
  06.06.2001 SVS
    ! Уточнение в функции TranslateKeyToVK - теперь wVirtualScanCode
      корректно транслируется.
  23.05.2001 SVS
    ! Макрос на Alt+Shift+Цифра
  17.05.2001 OT
    + при изменении размера консоли генерим KEY_CONSOLE_BUFFER_RESIZE.
  07.05.2001 SVS
    ! SysLog(); -> _D(SysLog());
  07.05.2001 SVS
    - При быстром поиске Alt-Shift-'-' не начинает поиск файлов, начинающихся
      с '_', а начинает с '-'. Раньше работало нормально.
  06.05.2001 DJ
    ! перетрях #include
  06.05.2001 ОТ
    ! Переименование Window в Frame :)
  05.05.2001 DJ
    + перетрях NWZ
  29.04.2001 ОТ
    + Внедрение NWZ от Третьякова
  28.04.2001 vvm
    + KEY_FOCUS_CHANGED для прорисовки кейбара.
  27.04.2001 SVS
    + Добавлены:
       "MsWheelDown" для KEY_MSWHEEL_DOWN и
       "MsWheelUp" для KEY_MSWHEEL_UP
      в массив FKeys1[]
    ! Не были учтены шифтовые клавиши при прокрутке колеса, из-за чего
      нельзя было использовать в макросах нечто вроде "ShiftMsWheelUp"
  26.04.2001 VVM
    - Выкинул нафиг MouseWheeled
    + Обработка спецклавиш KEY_MSWHEEL_XXXX
  24.04.2001 SVS
    + MouseWheeled - признак того, что крутанули колесо.
  16.04.2001 VVM
    + Прокрутка с шифтом подменяется на PgUp/PgDn
    + Opt.MouseWheelDelta - задает смещение для прокрутки. Сколько раз посылать UP/DOWN
  13.04.2001 VVM
    + Обработка колесика мышки под 2000.
  12.03.2001 SVS
    ! К терапевту предыдущие изменения - неудобно...
  07.03.2001 SVS
    ! Небольшое изменение - может быть и временное (как работает не пойму пока
      и на что потом повлияет - тоже не знаю, но Shift-F4 Shift-Enter, не
      отпуская Shift - работает корректно :-)
  28.02.2001 IS
    ! "CtrlObject->CmdLine." -> "CtrlObject->CmdLine->"
  25.02.2001 SVS
    ! Уточнения для Alt-Shift-...
  09.02.2001 IS
    + Подтверждение нажатия Esc в CheckForEsc (опционально)
  06.02.2001 SVS
    - ОНИ... :-)
      Приведение в порядок "непослушных" Divide & Multiple на цифровой клаве.
  05.02.2001 SVS
    - Снова про клавиши... :-( Все переводилось в Upper.
  01.02.2001 SVS
    - бага - неверно конвертилось имя клавиши :-(
  01.02.2001 SVS
    - Неверное преобразование клавиш в VK_* в функции TranslateKeyToVK()
      из-за чего не отрабатывал ENTER, etc в плагинах.
    - Не отрабатывались комбинации Alt-Shift-* и Alt-Shift-? при быстром
      поиске в панелях.
  28.01.2001 SVS
    ! Снова про... WriteInput (с учетом данных на VK_F16)
  24.01.2001 SVS
    ! Вернем взад содержимое WriteInput
  23.01.2001 SVS
    ! CalcKeyCode - дополнительный параметр - проверка на макросы.
    ! Исключения вызовов макросов при указании "не использовать макросы"
  21.01.2001 SVS
    ! Уточнения в WriteInput!
    ! WriteInput теперь возвращает результат в виде FALASE/TRUE.
    + WriteSequenceInput
  17.01.2001 SVS
    + Opt.ShiftsKeyRules - Правило на счет выбора механизма трансляции
      Alt-Буква для нелатинским буковок
  09.01.2001 SVS
    ! Грабер должен быть раньше Alt-Number-ввода
  05.01.2001 SVS
    - И снова CalcKeyCode - не работал Alt-Ins
  05.01.2001 SVS
    - База в "вычислителе" клавиш :-(
  04.01.2001 SVS
    + Переделка алгоритмов декодирования клавиш...
    + TranslateKeyToVK
  26.12.2000 SVS
    + вызов KeyMacroToText() (функция определена в macro.cpp)
  22.12.2000 SVS
    + Выделение в качестве самостоятельного модуля, после чего можно смело
      ваять интерфейс пвсевдоклавиатурного драйвера :-)
*/
