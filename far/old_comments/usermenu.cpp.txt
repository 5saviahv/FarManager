/*
Modify:
  02.03.2006 SVS
    ! Область действия макроса вернем только в том случае, если фрем, после отработки меню, остался тем же.
  07.12.2005 SVS
    + MACRO_USERMENU
  24.07.2005 WARP
    ! see 02033.LockUnlock.txt
  14.06.2005 SVS
    + SetBottomTitle()
  24.04.2005 AY
    ! GCC
  26.02.2005 SVS
    ! Для перерисовки панелей воспользуемся существующей функцией
      ShellUpdatePanels() - она более корректно отрисовывает панели.
    ! В процессе выполнения каждой строки UserMenu залочим обновление панелей.
  06.08.2004 SKV
    ! see 01825.MSVCRT.txt
  19.05.2004 SVS
    ! вместо "SetFileAttributes(Name,0)" выставим "SetFileAttributes(Name,FILE_ATTRIBUTE_NORMAL)"
      пусть баундчекер не блюет.
  24.02.2004 VVM
    - После поиска нужного меню-файла вернем папку на место !
  09.02.2004 SVS
    - BugZ#1016 - Самопроизвольное изменение текущего каталога
  03.09.2003 SVS
    ! Введено немного интелекта:
      a) изменена функция CanCloseDialog - другие коды возврата
         0 -все ОБИ,
         1 или 2 - ошибка и, соответственно, на какой контрол поставить фокус
      b) и, посредством Dialog::SendDlgMessage() после некорректного заполенения
         метки или хоткея ставим фокус на нужный элемент диалога.
  21.01.2003 SVS
    + xf_malloc,xf_realloc,xf_free - обертки вокруг malloc,realloc,free
      Просьба блюсти порядок и прописывать именно xf_* вместо простых.
  16.12.2002 SVS
    - BugZ#458 - Съезжает user menu
  23.09.2002 SVS
    - BugZ#634 - Лишний пробел после хоткея в юзер меню
  20.09.2002 SVS
    ! В юзвер-меню теперь можно вводить хоткей ала '&'
  12.07.2002 VVM
    ! Везде длина команды для меню - 4096, а при чтении файла 512 было.
  18.05.2002 SVS
    ! Возможность компиляции под BC 5.5
  15.05.2002 SKV
    + зафиксируем вход в модальный редактор
  26.04.2002 SVS
    - BugZ#484 - Addons\Macros\Space.reg (про заголовки консоли)
  05.03.2002 DJ
    ! передадим размер буфера в SubstFileName()
  01.03.2002 SVS
    ! Есть только одна функция создания временного файла - FarMkTempEx
  28.02.2002 SVS
    - BugZ#282 - отрисовка после вызова вьювера из меню с последующим
      переключением в редактор.
      Прорисовки ком.строки и панелей только в случае если они видимы
      (FrameManager->IsPanelsActive())
  15.02.2002 VVM
    ! Поскольку сепаратор в меню может иметь лэйб - поле надо очищать :)
  14.01.2002 IS
    ! chdir -> FarChDir
  08.01.2002 SVS
    ! Выкинем преобразование 0x10 в '>'. Оно сделано на глобальном уровне
      в InitRecodeOutTable()
  14.12.2001 IS
    - Баг: не сохранялись изменения редактирования меню по Alt-F4, если оно
      хранилось не в реестре.
    ! При выполнении команды меню не теряем старую командную строку.
  27.09.2001 IS
    - Левый размер при использовании strncpy
  05.09.2001 VVM
    ! При показе заголовка обрабатываем макроподстановки
  03.09.2001 VVM
    ! Коррекция максимальной длины для меню.
  31.08.2001 VVM
    ! Ёпрст... Опять хоткеи...
  29.08.2001 VVM
    ! Хоткеи. Оказалось - не все :)
  28.08.2001 VVM
    ! Бага с однобуквенными хоткеями в меню. Теперь вроде-бы все учел :)
  24.08.2001 VVM
    + Стрелки вправо/влево открывают/закрывают подменю соответственно
  20.08.2001 VVM
    ! Хоткей в метке работает при Fx (возвращаем, как було)
    ! Ошибка при выравнивании указателя подменю.
    + При вложенных меню показывает заголовки предыдущих
  20.08.2001 VVM
    ! Локальное меню не сохранялось при создании.
    + Введена доп.переменная - MenuNeedRefresh
      Устанавливается при изменении в меню для перерисовки.
  14.08.2001 SVS
    ! Сокращение кода за счет исключения повторяющихся последовательностей
  07.08.2001 SVS
    + Хоткей ' ' теперь не жилец :-)
    ! по разному оформляем строку для меню - Если хоткей - Fx, то
      '&' в лейбаке игнорируется - это обычный символ и он не удаляется!!!
  06.08.2001 SVS
    ! Избаляемся от рекурсии в трех местах (Ins, Del, F4), для этого
      кусок кода по заполнению менюхи вынесен в отдельную функцию FillUserMenu()
    + SubMenu теперь имеют нормальный заголовок, соответствующий
      названию подменю - для этого в ProcessSingleMenu() добавлен параметр -
      Title
  26.07.2001 SVS
    ! VFMenu уничтожен как класс
  18.07.2001 OT
    ! VFMenu
  11.07.2001 SVS
    ! Если слова "Register" в LNG-файле нету (нустая строка), то не выводит
      в заголовке меню круглые скобки
    ! Если задан хоткей, то удалим лишние '&' из лейбака.
  10.07.2001 SVS
    - Ликвидация багов с выравниванием
  02.07.2001 SVS
    - Bug (после 688): F9 c m l - не создавался файл "FarMenu.Ini"
  25.06.2001 SVS
    ! перенос проверки "if exist" чуток пониже :-))
  19.06.2001 SVS
    + Первая стадия: корректировка "if exist"
  17.06.2001 IS
    - Баг: выбиралось каким-то чудом то, что выбираться не должно, а именно -
      разделители.
  07.06.2001 SVS
    ! Добавлена предварительная обработка операторов "rem" и "::"
  05.06.2001 KM
    ! Поправочка. UserMenu не выставлял флаг VMENU_WRAPMODE.
  30.05.2001 OT
    - Борьба с отрисовкой панелей после исправления для борьбы с отрисовкой меню :))
  29.01.2001 VVM
    - Более точное исправление ALT+F4, хотя и не полное...
  28.05.2001 OT
    - Исправление ALTF4 в меню
    ! Добавление кода вызова модального редактора, в соответствии с NFZ
  21.05.2001 SVS
    ! struct MenuData|MenuItem
      Поля Selected, Checked, Separator и Disabled преобразованы в DWORD Flags
  07.05.2001 SVS
    ! 'ФАР пускается с ключем -a. В меню по F2 пункты с подменю справа
      обозначаюися ".". Хотелось бы ">".'
  06.05.2001 DJ
    ! перетрях #include
  01.05.2001 IS
    ! Теперь при выполнении команд из меню панели и их обновление не
      отключаются.
  29.04.2001 ОТ
    + Внедрение NWZ от Третьякова
  25.04.2001 DJ
    * новая константа EC_COMMAND_EXECUTED; не обновляем панели, если
      меню было закрыто без выбора команды
  28.02.2001 IS
    ! "CtrlObject->CmdLine." -> "CtrlObject->CmdLine->"
  27.02.2001 VVM
    ! Символы, зависимые от кодовой страницы
      /[\x01-\x08\x0B-\x0C\x0E-\x1F\xB0-\xDF\xF8-\xFF]/
      переведены в коды.
  11.02.2001 SVS
    ! Несколько уточнений кода в связи с изменениями в структуре MenuItem
  17.01.2001 SVS
    - Вернем обратно предыдущее изменение в связи с очередным уточнением клавиш
  09.01.2001 SVS
    - Для преобразования (Key>=KEY_F1 && Key<=KEY_F12) в индекс массива
      нужно сдвинуть результат (Key-KEY_F1) на 8 вправо.
  22.12.2000 IS
    ! Если не ввели метку и нажали "продолжить", то не выходим из диалога
      редактирования команд, т.к. теряем те команды, что, возможно, ввели.
      Для выхода из меню нужно воспользоваться esc или кнопкой "отменить".
  11.11.2000 SVS
    ! FarMkTemp() - убираем (как всегда - то ставим, то тут же убираем :-(((
  11.11.2000 SVS
    ! Используем конструкцию FarMkTemp()
  14.10.2000 VVM
    + Разделитель меню, если Метка пуста, а ХотКей="-"
  02.09.2000 tran
    - !@!, !#!@! bug
  28.07.2000 VVM
    + Обработка переменных окружения в названии меню
    - Исправлен баг с клавишей BkSpace
  24.07.2000 VVM
    + При показе главного меню в заголовок добавляет тип - FAR/Registry
  20.07.2000 tran 1.04
    - Bug#19
      ">" обозначающие подменю выравниваются по максимальной границе
  17.07.2000 VVM
    + При первом вызове не ищет меню из родительского каталога
    + SHIFT+F2 переключает Главное меню/локальное в цикле
  14.07.2000 VVM
    + Вызов главного меню по SHIFT+F2
    + Показ меню из родительского каталога по BkSpace
  28.06.2000 tran
    + выход из пользовтельского меню любого уровня вложенности
  25.06.2000 SVS
    ! Подготовка Master Copy
    ! Выделение в качестве самостоятельного модуля
*/
